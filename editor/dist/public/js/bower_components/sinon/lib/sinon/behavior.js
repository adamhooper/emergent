/**
 * Stub behavior
 *
 * @author Christian Johansen (christian@cjohansen.no)
 * @author Tim Fischbach (mail@timfischbach.de)
 * @license BSD
 *
 * Copyright (c) 2010-2013 Christian Johansen
 */

(function(e){function o(e,t){return typeof e=="string"?(this.exception=new Error(t||""),this.exception.name=e):e?this.exception=e:this.exception=new Error("Error"),this}function u(e,t){var n=e.callArgAt;if(n<0){var r=e.callArgProp;for(var i=0,s=t.length;i<s;++i){if(!r&&typeof t[i]=="function")return t[i];if(r&&t[i]&&typeof t[i][r]=="function")return t[i][r]}return null}return t[n]}function a(t,n,i){if(t.callArgAt<0){var s;return t.callArgProp?s=e.functionName(t.stub)+" expected to yield to '"+t.callArgProp+"', but no object with such a property was passed.":s=e.functionName(t.stub)+" expected to yield, but no callback was passed.",i.length>0&&(s+=" Received ["+r.call(i,", ")+"]"),s}return"argument at index "+t.callArgAt+" is not a function: "+n}function f(e,t){if(typeof e.callArgAt=="number"){var n=u(e,t);if(typeof n!="function")throw new TypeError(a(e,n,t));e.callbackAsync?s(function(){n.apply(e.callbackContext,e.callbackArguments)}):n.apply(e.callbackContext,e.callbackArguments)}}var t=typeof module!="undefined"&&module.exports;!e&&t&&(e=require("../sinon"));if(!e)return;var n=Array.prototype.slice,r=Array.prototype.join,i,s=function(){return typeof process=="object"&&typeof process.nextTick=="function"?process.nextTick:typeof setImmediate=="function"?setImmediate:function(e){setTimeout(e,0)}}();i={create:function(t){var n=e.extend({},e.behavior);return delete n.create,n.stub=t,n},isPresent:function(){return typeof this.callArgAt=="number"||this.exception||typeof this.returnArgAt=="number"||this.returnThis||this.returnValueDefined},invoke:function(e,t){f(this,t);if(this.exception)throw this.exception;return typeof this.returnArgAt=="number"?t[this.returnArgAt]:this.returnThis?e:this.returnValue},onCall:function(e){return this.stub.onCall(e)},onFirstCall:function(){return this.stub.onFirstCall()},onSecondCall:function(){return this.stub.onSecondCall()},onThirdCall:function(){return this.stub.onThirdCall()},withArgs:function(){throw new Error('Defining a stub by invoking "stub.onCall(...).withArgs(...)" is not supported. Use "stub.withArgs(...).onCall(...)" to define sequential behavior for calls with certain arguments.')},callsArg:function(t){if(typeof t!="number")throw new TypeError("argument index is not number");return this.callArgAt=t,this.callbackArguments=[],this.callbackContext=undefined,this.callArgProp=undefined,this.callbackAsync=!1,this},callsArgOn:function(t,n){if(typeof t!="number")throw new TypeError("argument index is not number");if(typeof n!="object")throw new TypeError("argument context is not an object");return this.callArgAt=t,this.callbackArguments=[],this.callbackContext=n,this.callArgProp=undefined,this.callbackAsync=!1,this},callsArgWith:function(t){if(typeof t!="number")throw new TypeError("argument index is not number");return this.callArgAt=t,this.callbackArguments=n.call(arguments,1),this.callbackContext=undefined,this.callArgProp=undefined,this.callbackAsync=!1,this},callsArgOnWith:function(t,r){if(typeof t!="number")throw new TypeError("argument index is not number");if(typeof r!="object")throw new TypeError("argument context is not an object");return this.callArgAt=t,this.callbackArguments=n.call(arguments,2),this.callbackContext=r,this.callArgProp=undefined,this.callbackAsync=!1,this},yields:function(){return this.callArgAt=-1,this.callbackArguments=n.call(arguments,0),this.callbackContext=undefined,this.callArgProp=undefined,this.callbackAsync=!1,this},yieldsOn:function(e){if(typeof e!="object")throw new TypeError("argument context is not an object");return this.callArgAt=-1,this.callbackArguments=n.call(arguments,1),this.callbackContext=e,this.callArgProp=undefined,this.callbackAsync=!1,this},yieldsTo:function(e){return this.callArgAt=-1,this.callbackArguments=n.call(arguments,1),this.callbackContext=undefined,this.callArgProp=e,this.callbackAsync=!1,this},yieldsToOn:function(e,t){if(typeof t!="object")throw new TypeError("argument context is not an object");return this.callArgAt=-1,this.callbackArguments=n.call(arguments,2),this.callbackContext=t,this.callArgProp=e,this.callbackAsync=!1,this},"throws":o,throwsException:o,returns:function(t){return this.returnValue=t,this.returnValueDefined=!0,this},returnsArg:function(t){if(typeof t!="number")throw new TypeError("argument index is not number");return this.returnArgAt=t,this},returnsThis:function(){return this.returnThis=!0,this}};for(var l in i)i.hasOwnProperty(l)&&l.match(/^(callsArg|yields)/)&&!l.match(/Async/)&&(i[l+"Async"]=function(e){return function(){var t=this[e].apply(this,arguments);return this.callbackAsync=!0,t}}(l));e.behavior=i,typeof define=="function"&&define.amd?define(["module"],function(e){e.exports=i}):t&&(module.exports=i)})(typeof sinon=="object"&&sinon||null);