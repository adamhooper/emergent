/**
 * Fake XMLHttpRequest object
 *
 * @author Christian Johansen (christian@cjohansen.no)
 * @license BSD
 *
 * Copyright (c) 2010-2013 Christian Johansen
 */

(function(e){function s(){function n(t){e.addEventListener(t,function(n){var r=e["on"+t];r&&typeof r=="function"&&r.call(this,n)})}this.readyState=s.UNSENT,this.requestHeaders={},this.requestBody=null,this.status=0,this.statusText="",this.upload=new o,sinon.xhr.supportsCORS&&(this.withCredentials=!1);var e=this,t=["loadstart","load","abort","loadend"];for(var r=t.length-1;r>=0;r--)n(t[r]);typeof s.onCreate=="function"&&s.onCreate(this)}function o(){this.eventListeners={progress:[],load:[],abort:[],error:[]}}function u(e){if(e.readyState!==s.OPENED)throw new Error("INVALID_STATE_ERR");if(e.sendFlag)throw new Error("INVALID_STATE_ERR")}function a(e,t){if(!e)return;for(var n=0,r=e.length;n<r;n+=1)t(e[n])}function f(e,t){for(var n=0;n<e.length;n++)if(t(e[n])===!0)return!0;return!1}function h(e){if(e.readyState!=s.OPENED)throw new Error("INVALID_STATE_ERR - "+e.readyState)}function p(e){if(e.readyState==s.DONE)throw new Error("Request done")}function d(e){if(e.async&&e.readyState!=s.HEADERS_RECEIVED)throw new Error("No headers received")}function v(e){if(typeof e!="string"){var t=new Error("Attempted to respond to fake XMLHttpRequest with "+e+", which is not a string.");throw t.name="InvalidBodyException",t}}typeof sinon=="undefined"&&(e.sinon={});var t=typeof ProgressEvent!="undefined",n=typeof CustomEvent!="undefined";sinon.xhr={XMLHttpRequest:e.XMLHttpRequest};var r=sinon.xhr;r.GlobalXMLHttpRequest=e.XMLHttpRequest,r.GlobalActiveXObject=e.ActiveXObject,r.supportsActiveX=typeof r.GlobalActiveXObject!="undefined",r.supportsXHR=typeof r.GlobalXMLHttpRequest!="undefined",r.workingXHR=r.supportsXHR?r.GlobalXMLHttpRequest:r.supportsActiveX?function(){return new r.GlobalActiveXObject("MSXML2.XMLHTTP.3.0")}:!1,r.supportsCORS="withCredentials"in new sinon.xhr.GlobalXMLHttpRequest;var i={"Accept-Charset":!0,"Accept-Encoding":!0,Connection:!0,"Content-Length":!0,Cookie:!0,Cookie2:!0,"Content-Transfer-Encoding":!0,Date:!0,Expect:!0,Host:!0,"Keep-Alive":!0,Referer:!0,TE:!0,Trailer:!0,"Transfer-Encoding":!0,Upgrade:!0,"User-Agent":!0,Via:!0};o.prototype.addEventListener=function(e,t){this.eventListeners[e].push(t)},o.prototype.removeEventListener=function(e,t){var n=this.eventListeners[e]||[];for(var r=0,i=n.length;r<i;++r)if(n[r]==t)return n.splice(r,1)},o.prototype.dispatchEvent=function(e){var t=this.eventListeners[e.type]||[];for(var n=0,r;(r=t[n])!=null;n++)r(e)};var l=function(e,t,n){switch(n.length){case 0:return e[t]();case 1:return e[t](n[0]);case 2:return e[t](n[0],n[1]);case 3:return e[t](n[0],n[1],n[2]);case 4:return e[t](n[0],n[1],n[2],n[3]);case 5:return e[t](n[0],n[1],n[2],n[3],n[4])}};s.filters=[],s.addFilter=function(e){this.filters.push(e)};var c=/MSIE 6/;s.defake=function(e,t){var n=new sinon.xhr.workingXHR;a(["open","setRequestHeader","send","abort","getResponseHeader","getAllResponseHeaders","addEventListener","overrideMimeType","removeEventListener"],function(t){e[t]=function(){return l(n,t,arguments)}});var r=function(t){a(t,function(t){try{e[t]=n[t]}catch(r){if(!c.test(navigator.userAgent))throw r}})},i=function(){e.readyState=n.readyState,n.readyState>=s.HEADERS_RECEIVED&&r(["status","statusText"]),n.readyState>=s.LOADING&&r(["responseText"]),n.readyState===s.DONE&&r(["responseXML"]),e.onreadystatechange&&e.onreadystatechange.call(e,{target:e})};if(n.addEventListener){for(var o in e.eventListeners)e.eventListeners.hasOwnProperty(o)&&a(e.eventListeners[o],function(e){n.addEventListener(o,e)});n.addEventListener("readystatechange",i)}else n.onreadystatechange=i;l(n,"open",t)},s.useFilters=!1,sinon.extend(s.prototype,sinon.EventTarget,{async:!0,open:function(t,n,r,i,o){this.method=t,this.url=n,this.async=typeof r=="boolean"?r:!0,this.username=i,this.password=o,this.responseText=null,this.responseXML=null,this.requestHeaders={},this.sendFlag=!1;if(sinon.FakeXMLHttpRequest.useFilters===!0){var u=arguments,a=f(s.filters,function(e){return e.apply(this,u)});if(a)return sinon.FakeXMLHttpRequest.defake(this,arguments)}this.readyStateChange(s.OPENED)},readyStateChange:function(n){this.readyState=n;if(typeof this.onreadystatechange=="function")try{this.onreadystatechange()}catch(r){sinon.logError("Fake XHR onreadystatechange handler",r)}this.dispatchEvent(new sinon.Event("readystatechange"));switch(this.readyState){case s.DONE:this.dispatchEvent(new sinon.Event("load",!1,!1,this)),this.dispatchEvent(new sinon.Event("loadend",!1,!1,this)),this.upload.dispatchEvent(new sinon.Event("load",!1,!1,this)),t&&this.upload.dispatchEvent(new sinon.ProgressEvent("progress",{loaded:100,total:100}))}},setRequestHeader:function(t,n){u(this);if(i[t]||/^(Sec-|Proxy-)/.test(t))throw new Error('Refused to set unsafe header "'+t+'"');this.requestHeaders[t]?this.requestHeaders[t]+=","+n:this.requestHeaders[t]=n},setResponseHeaders:function(t){h(this),this.responseHeaders={};for(var n in t)t.hasOwnProperty(n)&&(this.responseHeaders[n]=t[n]);this.async?this.readyStateChange(s.HEADERS_RECEIVED):this.readyState=s.HEADERS_RECEIVED},send:function(t){u(this);if(!/^(get|head)$/i.test(this.method)){if(this.requestHeaders["Content-Type"]){var n=this.requestHeaders["Content-Type"].split(";");this.requestHeaders["Content-Type"]=n[0]+";charset=utf-8"}else this.requestHeaders["Content-Type"]="text/plain;charset=utf-8";this.requestBody=t}this.errorFlag=!1,this.sendFlag=this.async,this.readyStateChange(s.OPENED),typeof this.onSend=="function"&&this.onSend(this),this.dispatchEvent(new sinon.Event("loadstart",!1,!1,this))},abort:function(){this.aborted=!0,this.responseText=null,this.errorFlag=!0,this.requestHeaders={},this.readyState>sinon.FakeXMLHttpRequest.UNSENT&&this.sendFlag&&(this.readyStateChange(sinon.FakeXMLHttpRequest.DONE),this.sendFlag=!1),this.readyState=sinon.FakeXMLHttpRequest.UNSENT,this.dispatchEvent(new sinon.Event("abort",!1,!1,this)),this.upload.dispatchEvent(new sinon.Event("abort",!1,!1,this)),typeof this.onerror=="function"&&this.onerror()},getResponseHeader:function(t){if(this.readyState<s.HEADERS_RECEIVED)return null;if(/^Set-Cookie2?$/i.test(t))return null;t=t.toLowerCase();for(var n in this.responseHeaders)if(n.toLowerCase()==t)return this.responseHeaders[n];return null},getAllResponseHeaders:function(){if(this.readyState<s.HEADERS_RECEIVED)return"";var t="";for(var n in this.responseHeaders)this.responseHeaders.hasOwnProperty(n)&&!/^Set-Cookie2?$/i.test(n)&&(t+=n+": "+this.responseHeaders[n]+"\r\n");return t},setResponseBody:function(t){p(this),d(this),v(t);var n=this.chunkSize||10,r=0;this.responseText="";do this.async&&this.readyStateChange(s.LOADING),this.responseText+=t.substring(r,r+n),r+=n;while(r<t.length);var i=this.getResponseHeader("Content-Type");if(this.responseText&&(!i||/(text\/xml)|(application\/xml)|(\+xml)/.test(i)))try{this.responseXML=s.parseXML(this.responseText)}catch(o){}this.async?this.readyStateChange(s.DONE):this.readyState=s.DONE},respond:function(t,n,r){this.status=typeof t=="number"?t:200,this.statusText=s.statusCodes[this.status],this.setResponseHeaders(n||{}),this.setResponseBody(r||"")},uploadProgress:function(n){t&&this.upload.dispatchEvent(new sinon.ProgressEvent("progress",n))},uploadError:function(t){n&&this.upload.dispatchEvent(new sinon.CustomEvent("error",{detail:t}))}}),sinon.extend(s,{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4}),s.parseXML=function(t){var n;if(typeof DOMParser!="undefined"){var r=new DOMParser;n=r.parseFromString(t,"text/xml")}else n=new ActiveXObject("Microsoft.XMLDOM"),n.async="false",n.loadXML(t);return n},s.statusCodes={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"},sinon.useFakeXMLHttpRequest=function(){return sinon.FakeXMLHttpRequest.restore=function(n){r.supportsXHR&&(e.XMLHttpRequest=r.GlobalXMLHttpRequest),r.supportsActiveX&&(e.ActiveXObject=r.GlobalActiveXObject),delete sinon.FakeXMLHttpRequest.restore,n!==!0&&delete sinon.FakeXMLHttpRequest.onCreate},r.supportsXHR&&(e.XMLHttpRequest=sinon.FakeXMLHttpRequest),r.supportsActiveX&&(e.ActiveXObject=function(t){return t=="Microsoft.XMLHTTP"||/^Msxml2\.XMLHTTP/i.test(t)?new sinon.FakeXMLHttpRequest:new r.GlobalActiveXObject(t)}),sinon.FakeXMLHttpRequest},sinon.FakeXMLHttpRequest=s})(typeof global=="object"?global:this),typeof module!="undefined"&&module.exports&&(module.exports=sinon);