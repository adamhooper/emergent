/**
  * Spy calls
  *
  * @author Christian Johansen (christian@cjohansen.no)
  * @author Maximilian Antoni (mail@maxantoni.de)
  * @license BSD
  *
  * Copyright (c) 2010-2013 Christian Johansen
  * Copyright (c) 2013 Maximilian Antoni
  */

(function(e){function n(t,n,i){var s=e.functionName(t)+n;throw i.length&&(s+=" Received ["+r.call(i).join(", ")+"]"),new Error(s)}function s(t,n,r,s,o,u){if(typeof u!="number")throw new TypeError("Call id is not a number");var a=e.create(i);return a.proxy=t,a.thisValue=n,a.args=r,a.returnValue=s,a.exception=o,a.callId=u,a}var t=typeof module!="undefined"&&module.exports;!e&&t&&(e=require("../sinon"));if(!e)return;var r=Array.prototype.slice,i={calledOn:function(n){return e.match&&e.match.isMatcher(n)?n.test(this.thisValue):this.thisValue===n},calledWith:function(){for(var n=0,r=arguments.length;n<r;n+=1)if(!e.deepEqual(arguments[n],this.args[n]))return!1;return!0},calledWithMatch:function(){for(var n=0,r=arguments.length;n<r;n+=1){var i=this.args[n],s=arguments[n];if(!e.match||!e.match(s).test(i))return!1}return!0},calledWithExactly:function(){return arguments.length==this.args.length&&this.calledWith.apply(this,arguments)},notCalledWith:function(){return!this.calledWith.apply(this,arguments)},notCalledWithMatch:function(){return!this.calledWithMatch.apply(this,arguments)},returned:function(n){return e.deepEqual(n,this.returnValue)},threw:function(t){return typeof t=="undefined"||!this.exception?!!this.exception:this.exception===t||this.exception.name===t},calledWithNew:function(){return this.proxy.prototype&&this.thisValue instanceof this.proxy},calledBefore:function(e){return this.callId<e.callId},calledAfter:function(e){return this.callId>e.callId},callArg:function(e){this.args[e]()},callArgOn:function(e,t){this.args[e].apply(t)},callArgWith:function(e){this.callArgOnWith.apply(this,[e,null].concat(r.call(arguments,1)))},callArgOnWith:function(e,t){var n=r.call(arguments,2);this.args[e].apply(t,n)},yield:function(){this.yieldOn.apply(this,[null].concat(r.call(arguments,0)))},yieldOn:function(e){var t=this.args;for(var i=0,s=t.length;i<s;++i)if(typeof t[i]=="function"){t[i].apply(e,r.call(arguments,1));return}n(this.proxy," cannot yield since no callback was passed.",t)},yieldTo:function(e){this.yieldToOn.apply(this,[e,null].concat(r.call(arguments,1)))},yieldToOn:function(e,t){var i=this.args;for(var s=0,o=i.length;s<o;++s)if(i[s]&&typeof i[s][e]=="function"){i[s][e].apply(t,r.call(arguments,2));return}n(this.proxy," cannot yield to '"+e+"' since no callback was passed.",i)},toString:function(){var t=this.proxy.toString()+"(",n=[];for(var r=0,i=this.args.length;r<i;++r)n.push(e.format(this.args[r]));return t=t+n.join(", ")+")",typeof this.returnValue!="undefined"&&(t+=" => "+e.format(this.returnValue)),this.exception&&(t+=" !"+this.exception.name,this.exception.message&&(t+="("+this.exception.message+")")),t}};i.invokeCallback=i.yield,s.toString=i.toString,e.spyCall=s,typeof define=="function"&&define.amd?define(["module"],function(e){e.exports=s}):t&&(module.exports=s)})(typeof sinon=="object"&&sinon||null);